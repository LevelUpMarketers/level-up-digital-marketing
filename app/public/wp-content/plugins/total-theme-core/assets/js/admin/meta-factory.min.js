window.wpexMetaFactory=window.wpexMetaFactory||{},function(e,t,a){"use strict";e(document).ready((function(){t.init()})),t.init=function(){var a=t.metabox();t.fieldColorPicker(a),t.sortableGroups(a),a.on("change",'input[type="text"],input[type="hidden"]',t.handleInputChange),a.on("click",".wpex-mf-help-button",t.handleHelpButtonClick),a.on("keyup",".wpex-mf-help-button",t.handleHelpButtonType),a.on("click",".wpex-mf-upload",t.handleUploadClick),a.on("click",".wpex-mf-upload-remove",t.handleUploadRemove),a.on("click",".wpex-mf-clone-group",t.cloneGroup),a.on("click",".wpex-mf-remove-group",t.removeGroup),a.on("click",".wpex-mf-metabox__tab a",t.handleTabClick),a.on("click",".wpex-mf-metabox__button-group button",t.handleButtonGroupClick),e(document).click(t.onDocClick)},t.metabox=function(){return t.$metabox||(t.$metabox=e(".wpex-mf-metabox")),t.$metabox},t.sortableGroups=function(a){const n=a.find('.wpex-mf-group-set[data-wpex-mf-sortable="1"]');n.length&&n.sortable({connectWith:".wpex-mf-group",handle:".wpex-mf-group-header",cancel:".wpex-mf-group-header-actions",update:function(a,n){const i=e(this).closest(".wpex-mf-group-set");i.find(".wpex-mf-group").each((function(a){e(this).find(".wpex-mf-group-set-index").text(a+1),t.updateIndexes(i)}))}})},t.fieldColorPicker=function(t){"function"==typeof e.fn.wpColorPicker&&e(".wpex-mf-colorpicker",t).wpColorPicker()},t.handleInputChange=function(a){const n=e(this),i=n.closest(".wpex-mf-field--upload");if(i){const e=n.val(),a=i.find(".wpex-mf-upload-preview");e?t.fieldPreviewAJAX(a,e):t.clearPreview(a)}},t.handleHelpButtonClick=function(a){var n=e(this),i=n.attr("aria-expanded"),o=n.parents(".wpex-mf-tr").find("#"+n.attr("aria-controls"));t.hideAllHelpButtons(n),"false"===i?(o.removeAttr("hidden"),n.attr("aria-expanded","true")):(o.attr("hidden",!0),n.attr("aria-expanded","false")),a.preventDefault()},t.handleHelpButtonType=function(t){if("Escape"!==t.key)return;const a=e(this);"true"===a.attr("aria-expanded")&&(a.parents(".wpex-mf-tr").find("#"+a.attr("aria-controls")).attr("hidden",!0),a.attr("aria-expanded","false"))},t.handleUploadClick=function(a){a.preventDefault(),t.fieldUpload(e(this).closest("td").find("input"))},t.handleUploadRemove=function(a){a.preventDefault(),t.clearPreview(e(this).closest("td").find(".wpex-mf-upload-preview"))},t.fieldUpload=function(a){if(!wp)return;t.mediaFrame&&t.mediaFrame.detach(),e("#wpex-mf-metabox-upload").length&&e("#wpex-mf-metabox-upload").remove();const n={id:"wpex-mf-metabox-upload",frame:"post",state:"insert",filterable:"uploaded",multiple:!1,syncSelection:!1,autoSelect:!0},i=a.closest("td"),o=i.find(".wpex-mf-upload");if(o){const e=o.attr("data-wpex-mf-media-type");e&&"all"!==e&&(n.library={type:e})}t.mediaFrame=wp.media.frames.file_frame=wp.media(n),t.mediaFrame.on("open",(function(){e("#wpex-mf-metabox-upload").addClass("hide-menu")}));const p=i.find(".wpex-mf-upload-preview");t.mediaFrame.on("insert",(function(){const e=t.mediaFrame.state().get("selection").first().toJSON()[a.data("selection")];a.val(e),p.length&&t.fieldPreviewAJAX(p,e)})),t.mediaFrame.open()},t.fieldPreviewAJAX=function(e,t){const n=e.find(".wpex-mf-upload-preview__content");e.addClass("wpex-mf-upload-preview--empty"),n.addClass("hidden"),n.empty();const i=e.find(".wpex-mf-upload-preview__loader");i.show();const o=new XMLHttpRequest,p="action=wpex_mf_field_preview_ajax&field_value="+t+"&nonce="+a.ajax_nonce;o.onload=function(){if(4==o.readyState&&200==o.status){const t=this.responseText;t&&(e.removeClass("wpex-mf-upload-preview--empty"),n.html(t),n.removeClass("hidden"))}else console.log(this.responseText);i.hide()},o.open("POST",window.ajaxurl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),o.send(p)},t.clearPreview=function(e){e.length&&(e.addClass("wpex-mf-upload-preview--empty"),e.find(".wpex-mf-upload-preview__content").addClass("hidden"),e.closest("td").find("input").val(""))},t.cloneGroup=function(a){a.preventDefault();var n=e(this).prev(".wpex-mf-group-set"),i=n.find(".wpex-mf-group:last").clone("true");i.appendTo(n),t.resetFields(i),t.updateIndexes(n),t.setFocus(i)},t.resetFields=function(a){a.find("input, textarea").each((function(){"checkbox"==e(this).attr("type")?e(this).prop("checked",!1):e(this).val("")})),a.find(".wpex-mf-upload-preview").each((function(){t.clearPreview(e(this))})),a.find("select").each((function(){e(this).val(e(this).find("option:first-child").val())}))},t.updateIndexes=function(t){t.find(".wpex-mf-group").each((function(t){var a=e(this);a.find(".wpex-mf-group-set-index").text((t+1).toString()),a.find("label.wpex-mf-label").each((function(){var a=e(this);e(this).attr("for",a.attr("for").replace(/-(\d+)-/,"-"+t+"-"))})),a.find("input, select, textarea").each((function(){var a=e(this);a.attr("id",a.attr("id").replace(/-(\d+)-/,"-"+t+"-")),a.attr("name",a.attr("name").replace(/\[(\d+)\]/,"["+t+"]"))}))}))},t.removeGroup=function(n){if(n.preventDefault(),confirm(a.delete_group_confirm)){var i=e(this).closest(".wpex-mf-group"),o=parseInt(i.find(".wpex-mf-group-set-index").text()),p=e(this).closest(".wpex-mf-group-set");p.find(".wpex-mf-group").length>1?(i.remove(),t.updateIndexes(p,o)):t.resetFields(i)}},t.hideAllHelpButtons=function(a){var n=t.metabox().find(".wpex-mf-desc--has-tip");n.length&&n.each((function(){var t=e(this),n=t.parents(".wpex-mf-tr").find(".wpex-mf-help-button");n.not(a)&&(t.attr("hidden",!0),n.attr("aria-expanded","false"))}))},t.onDocClick=function(e){var a=e.target;a.closest(".wpex-mf-desc--has-tip")||a.closest(".wpex-mf-help-button")||t.hideAllHelpButtons()},t.setFocus=function(e){e.find("select, input, textarea, button, a").filter(":visible").first().focus()},t.handleTabClick=function(t){t.preventDefault();const a=e(this),n=a.parent("li"),i=n.parent("ul"),o=a.attr("aria-controls");i.find("li").each((function(){e(this).removeClass("wp-tab-active"),e(this).find("a").attr("aria-selected","false")})),n.closest(".wpex-mf-metabox").find(".wp-tab-panel").each((function(){o===e(this).attr("id")?e(this).removeClass("hidden"):e(this).addClass("hidden")})),n.addClass("wp-tab-active"),a.attr("aria-selected","true")},t.handleButtonGroupClick=function(t){t.preventDefault();const a=e(this).closest(".wpex-mf-metabox__button-group"),n=e(this).closest("td").find("input"),i=e(this).val()||"";a.find("button").each((function(){e(this).attr("aria-pressed","false")})),e(this).attr("aria-pressed","true"),n.val(i).trigger("change")}}(jQuery,window.wpexMetaFactory,totalthemecore_admin_meta_factory_params);